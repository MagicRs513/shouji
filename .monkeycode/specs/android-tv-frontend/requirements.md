# LunaTV 安卓电视前端 - 需求文档

## 简介

本文档定义了 LunaTV Enhanced Edition 后端的安卓电视前端应用的需求。该前端应用将作为 LunaTV 后端系统的完美配套,为电视用户提供原生、流畅的观影体验。

## 术语表

- **LunaTV 后端**: 基于 Next.js 16 的全功能影视聚合播放平台,提供多源搜索、播放、直播等功能
- **TVBox**: 第三方安卓电视播放器,支持 JSON 配置格式
- **安卓电视前端**: 本项目开发的原生安卓应用,专门针对电视大屏交互设计
- **用户认证**: 支持本地密码、OIDC(多种Provider)、Telegram、卡密等多种登录方式
- **Token 认证**: LunaTV 后端提供的用户专属 Token 或全局 Token 机制
- **视频源**: MacCMS、CSP 等格式的影视资源站点
- **IPTV 直播**: M3U/M3U8 格式的电视直播流
- **EPG**: Electronic Program Guide,电子节目单,提供直播频道的节目时间表
- **弹幕系统**: 从第三方平台聚合的用户评论数据流

## 功能需求

### FR1 用户认证

**用户故事**: 作为用户,我想要登录到 LunaTV 系统,以便访问受保护的功能和个性化服务。

#### 验收标准

1. **WHEN 用户启动应用时,系统 SHALL 显示登录界面**
2. **WHEN 用户输入用户名和密码并点击登录按钮时,系统 SHALL 向 /api/login 端点发送认证请求**
3. **IF 认证成功,系统 SHALL 存储 user_auth Cookie 并跳转至主界面**
4. **IF 认证失败,系统 SHALL 显示错误提示信息**
5. **WHEN 用户选择 OIDC 认证时,系统 SHALL 显示可用的 Provider 列表(Google、Microsoft、GitHub、Facebook、微信、Apple、LinuxDo)**
6. **WHEN 用户选择某个 Provider 时,系统 SHALL 打开浏览器进行授权流程**
7. **IF 用户启用信任网络模式,系统 SHALL 检测客户端 IP 并在白名单范围内时自动跳过登录**

### FR2 主界面导航

**用户故事**: 作为用户,我想要一个清晰易用的主界面,以便快速浏览和访问各类内容。

#### 验收标准

1. **WHEN 用户登录成功后,系统 SHALL 显示主界面导航栏**
2. **WHEN 用户在主界面时,系统 SHALL 显示以下分类选项卡:首页、影视、直播、YouTube、网盘、短剧、AI 推荐、我的**
3. **WHEN 用户使用遥控器左右导航键时,系统 SHALL 高亮当前选中的选项卡**
4. **WHEN 用户按下确认键时,系统 SHALL 跳转到对应分类页面**
5. **WHEN 用户在首页时,系统 SHALL 显示英雄横幅、热门推荐、继续观看、新剧集提醒**

### FR3 影视搜索与浏览

**用户故事**: 作为用户,我想要搜索和浏览影视内容,以便找到想看的影片。

#### 验收标准

1. **WHEN 用户点击搜索按钮或使用语音搜索时,系统 SHALL 显示搜索输入框**
2. **WHEN 用户输入搜索关键词并提交时,系统 SHALL 向 /api/search 端点发送请求**
3. **WHEN 系统接收到搜索结果时,系统 SHALL 以网格形式显示视频卡片**
4. **WHEN 用户选择某个视频卡片时,系统 SHALL 显示视频详情界面**
5. **WHEN 用户在影视分类页面时,系统 SHALL 支持按类型、年份、地区筛选**
6. **WHEN 用户浏览影视列表时,系统 SHALL 支持虚拟滚动以流畅加载大量内容**

### FR4 视频详情与播放

**用户故事**: 作为用户,我想要查看视频详情并播放,以便享受观影体验。

#### 验收标准

1. **WHEN 用户选择某个视频时,系统 SHALL 显示视频海报、标题、评分、演职人员、剧情简介**
2. **WHEN 用户点击播放按钮时,系统 SHALL 获取播放源列表**
3. **WHEN 系统获取到播放源时,系统 SHALL 按权重排序并显示可用播放源**
4. **WHEN 用户选择某个播放源时,系统 SHALL 调用原生播放器播放视频**
5. **WHEN 视频播放时,系统 SHALL 支持遥控器控制播放、暂停、进度跳转、音量调节**
6. **WHEN 视频播放时,系统 SHALL 自动记录播放进度到 /api/playrecords 端点**
7. **WHEN 用户切换播放源时,系统 SHALL 保留当前播放进度**

### FR5 IPTV 直播

**用户故事**: 作为用户,我想要观看 IPTV 直播,以便实时观看电视频道。

#### 验收标准

1. **WHEN 用户进入直播分类时,系统 SHALL 显示直播频道列表**
2. **WHEN 系统加载直播源时,系统 SHALL 请求 /api/live 端点获取 M3U/M3U8 数据**
3. **WHEN 系统获取到 EPG 数据时,系统 SHALL 显示当前频道节目单**
4. **WHEN 用户选择某个直播频道时,系统 SHALL 调用原生播放器播放直播流**
5. **IF 直播流支持 CORS,系统 SHALL 使用客户端直连模式播放**
6. **IF 直播流不支持 CORS,系统 SHALL 使用服务器代理模式播放**
7. **WHEN 用户在直播页面时,系统 SHALL 显示当前节目和下一个节目信息**

### FR6 YouTube 集成

**用户故事**: 作为用户,我想要在电视上观看 YouTube 内容,以便享受丰富的视频资源。

#### 验收标准

1. **WHEN 用户进入 YouTube 分类时,系统 SHALL 显示 YouTube 搜索界面**
2. **WHEN 用户输入搜索关键词时,系统 SHALL 向 /api/youtube 端点发送请求**
3. **WHEN 系统获取到搜索结果时,系统 SHALL 显示 YouTube 视频卡片**
4. **WHEN 用户选择某个 YouTube 视频时,系统 SHALL 显示视频详情**
5. **WHEN 用户点击播放按钮时,系统 SHALL 使用 YouTube 嵌入播放器或直接播放**
6. **WHEN 用户在 YouTube 分类时,系统 SHALL 支持按时间筛选(今天、本周、本月、今年)**

### FR7 网盘搜索

**用户故事**: 作为用户,我想要搜索网盘资源,以便找到更丰富的视频内容。

#### 验收标准

1. **WHEN 用户进入网盘搜索分类时,系统 SHALL 显示搜索界面**
2. **WHEN 用户输入搜索关键词时,系统 SHALL 向 /api/netdisk 端点发送请求**
3. **WHEN 系统获取到搜索结果时,系统 SHALL 显示网盘资源列表**
4. **WHEN 用户选择某个网盘资源时,系统 SHALL 显示资源详情和下载链接**
5. **WHEN 用户筛选网盘资源时,系统 SHALL 支持按文件类型、大小、时间筛选**

### FR8 短剧功能

**用户故事**: 作为用户,我想要观看短剧,以便在碎片时间享受娱乐内容。

#### 验收标准

1. **WHEN 用户进入短剧分类时,系统 SHALL 显示短剧列表**
2. **WHEN 用户搜索短剧时,系统 SHALL 向 /api/shortdrama 端点发送请求**
3. **WHEN 系统获取到短剧结果时,系统 SHALL 显示短剧卡片**
4. **WHEN 用户选择某个短剧时,系统 SHALL 显示短剧详情和剧集列表**
5. **WHEN 用户选择播放某集时,系统 SHALL 调用原生播放器播放**
6. **IF 某集不可用,系统 SHALL 自动跳转到下一集**

### FR9 AI 智能推荐

**用户故事**: 作为用户,我想要获得 AI 智能推荐,以便发现更多感兴趣的内容。

#### 验收标准

1. **WHEN 用户进入 AI 推荐分类时,系统 SHALL 显示 AI 对话界面**
2. **WHEN 用户输入推荐请求时,系统 SHALL 向 /api/ai-recommend 端点发送请求**
3. **WHEN 系统返回推荐结果时,系统 SHALL 显示推荐内容列表**
4. **WHEN 用户询问特定影片时,系统 SHALL 自动注入影片上下文信息**
5. **WHEN 用户使用 Tavily 搜索模式时,系统 SHALL 显示实时网络搜索结果**
6. **WHEN 系统显示推荐内容时,系统 SHALL 支持 Markdown 格式渲染**

### FR10 弹幕系统

**用户故事**: 作为用户,我想要观看弹幕,以便获得更丰富的观影体验。

#### 验收标准

1. **WHEN 视频播放时,系统 SHALL 自动加载弹幕数据**
2. **WHEN 系统加载弹幕时,系统 SHALL 请求 /api/danmu-external 端点**
3. **WHEN 系统获取到弹幕数据时,系统 SHALL 在播放器上显示弹幕流**
4. **WHEN 用户调整弹幕设置时,系统 SHALL 支持调整字号、速度、透明度、显示区域**
5. **WHEN 系统渲染弹幕时,系统 SHALL 自动过滤解说、预告等不相关内容**

### FR11 收藏与播放记录

**用户故事**: 作为用户,我想要管理我的收藏和播放记录,以便快速访问喜欢的内容。

#### 验收标准

1. **WHEN 用户进入"我的"分类时,系统 SHALL 显示用户菜单选项**
2. **WHEN 用户点击"我的收藏"时,系统 SHALL 请求 /api/favorites 端点并显示收藏列表**
3. **WHEN 用户收藏某个视频时,系统 SHALL 向 /api/favorites 端点发送添加请求**
4. **WHEN 用户取消收藏时,系统 SHALL 向 /api/favorites 端点发送删除请求**
5. **WHEN 用户收藏内容时,系统 SHALL 支持分类筛选(电影、剧集、综艺、短剧、番剧)**
6. **WHEN 用户在主界面时,系统 SHALL 显示"继续观看"区域,展示未看完的内容**
7. **WHEN 用户有新剧集时,系统 SHALL 显示"新剧集提醒"徽章**

### FR12 用户设置

**用户故事**: 作为用户,我想要配置应用设置,以便个性化我的使用体验。

#### 验收标准

1. **WHEN 用户进入设置页面时,系统 SHALL 显示设置选项列表**
2. **WHEN 用户调整弹幕设置时,系统 SHALL 保存配置并实时应用**
3. **WHEN 用户调整播放器设置时,系统 SHALL 支持配置缓冲模式(省流、均衡、高质)**
4. **WHEN 用户配置跳过片头片尾时,系统 SHALL 支持手动标记和自动跳转**
5. **WHEN 用户切换主题时,系统 SHALL 支持亮色和暗色主题切换**
6. **WHEN 用户配置 TVBox Token 时,系统 SHALL 支持 Token 输入和验证**

### FR13 TVBox 兼容模式

**用户故事**: 作为用户,我想要使用 TVBox 格式配置,以便与现有 TVBox 生态兼容。

#### 验收标准

1. **WHEN 用户启用 TVBox 兼容模式时,系统 SHALL 请求 /api/tvbox 端点获取配置**
2. **WHEN 系统获取到配置时,系统 SHALL 解析 JSON 格式配置文件**
3. **WHEN 系统解析配置时,系统 SHALL 加载 sites、lives、parses、flags、ijk 等配置**
4. **WHEN 用户使用 TVBox 模式时,系统 SHALL 支持 Spider JAR 加载和运行**
5. **WHEN 用户配置 Token 时,系统 SHALL 支持全局 Token 和用户专属 Token**
6. **WHEN 用户启用成人内容过滤时,系统 SHALL 根据 filter 参数控制显示**

### FR14 性能与缓存

**用户故事**: 作为用户,我想要流畅的应用体验,以便享受无卡顿的观影。

#### 验收标准

1. **WHEN 应用启动时,系统 SHALL 加载上次会话的缓存数据**
2. **WHEN 用户浏览内容时,系统 SHALL 使用虚拟滚动优化性能**
3. **WHEN 系统请求数据时,系统 SHALL 优先从缓存读取**
4. **WHEN 缓存过期时,系统 SHALL 自动刷新数据**
5. **WHEN 用户播放视频时,系统 SHALL 优先使用本地缓存**
6. **WHEN 系统加载图片时,系统 SHALL 使用图片代理避免 403 错误**

### FR15 错误处理与恢复

**用户故事**: 作为用户,我想要稳定的体验,以便在网络异常时能够恢复正常使用。

#### 验收标准

1. **IF 网络请求失败,系统 SHALL 显示友好的错误提示**
2. **IF 主 API 请求失败,系统 SHALL 自动切换到备用 API**
3. **IF 播放源加载失败,系统 SHALL 自动切换到下一个可用源**
4. **IF 视频播放失败,系统 SHALL 显示错误信息并提供重试选项**
5. **IF Token 过期,系统 SHALL 提示用户重新登录**
6. **IF 服务器响应超时,系统 SHALL 显示超时提示并提供重试选项**

### FR16 语音搜索

**用户故事**: 作为用户,我想要使用语音搜索,以便更方便地查找内容。

#### 验收标准

1. **WHEN 用户按下语音搜索按钮时,系统 SHALL 启动语音识别**
2. **WHEN 用户说话时,系统 SHALL 将语音转换为文本**
3. **WHEN 语音识别完成时,系统 SHALL 自动执行搜索**
4. **WHEN 系统无法识别语音时,系统 SHALL 显示识别失败提示**
5. **WHEN 用户使用语音搜索时,系统 SHALL 支持多语言识别**

### FR17 投屏功能

**用户故事**: 作为用户,我想要使用投屏功能,以便在电视上观看手机上的内容。

#### 验收标准

1. **WHEN 用户启用投屏时,系统 SHALL 搜索可用的投屏设备**
2. **WHEN 系统发现投屏设备时,系统 SHALL 显示设备列表**
3. **WHEN 用户选择某个设备时,系统 SHALL 建立投屏连接**
4. **WHEN 投屏连接成功时,系统 SHALL 将视频投放到电视**
5. **WHEN 投屏过程中出现错误,系统 SHALL 显示错误提示并提供重连选项**

### FR18 下载与离线观看

**用户故事**: 作为用户,我想要下载视频并离线观看,以便在没有网络时也能享受内容。

#### 验收标准

1. **WHEN 用户点击下载按钮时,系统 SHALL 开始下载 M3U8 视频**
2. **WHEN 下载过程中,系统 SHALL 显示下载进度**
3. **WHEN 下载完成时,系统 SHALL 保存视频到本地存储**
4. **WHEN 用户在离线状态时,系统 SHALL 显示已下载的视频列表**
5. **WHEN 用户观看已下载视频时,系统 SHALL 从本地加载播放**
6. **WHEN 用户删除已下载视频时,系统 SHALL 释放本地存储空间**

### FR19 多用户支持

**用户故事**: 作为家庭用户,我想要支持多用户切换,以便不同家庭成员享受个性化体验。

#### 验收标准

1. **WHEN 应用启动时,系统 SHALL 显示用户列表**
2. **WHEN 用户选择某个用户时,系统 SHALL 切换到该用户的账号**
3. **WHEN 用户添加新用户时,系统 SHALL 支持创建用户账号**
4. **WHEN 用户切换账号时,系统 SHALL 加载该用户的收藏和播放记录**
5. **WHEN 不同用户登录时,系统 SHALL 保持各自的设置和偏好**

### FR20 辅助功能

**用户故事**: 作为特殊需求用户,我想要使用辅助功能,以便更好地使用应用。

#### 验收标准

1. **WHEN 用户启用屏幕阅读器时,系统 SHALL 提供语音播报功能**
2. **WHEN 用户调整字体大小时,系统 SHALL 支持大字体模式**
3. **WHEN 用户启用高对比度模式时,系统 SHALL 调整界面颜色**
4. **WHEN 用户使用语音控制时,系统 SHALL 支持语音命令操作**
5. **WHEN 用户需要字幕时,系统 SHALL 支持外挂字幕加载**

---

## 附录

### 相关 API 端点列表

- `/api/login` - 用户登录
- `/api/register` - 用户注册
- `/api/logout` - 用户登出
- `/api/auth/[...]/route.ts` - OIDC 认证
- `/api/telegram` - Telegram 认证
- `/api/search` - 影视搜索
- `/api/detail` - 视频详情
- `/api/playrecords` - 播放记录
- `/api/favorites` - 收藏管理
- `/api/live` - IPTV 直播
- `/api/youtube` - YouTube 集成
- `/api/netdisk` - 网盘搜索
- `/api/shortdrama` - 短剧功能
- `/api/ai-recommend` - AI 推荐
- `/api/danmu-external` - 弹幕系统
- `/api/tvbox` - TVBox 配置
- `/api/image-proxy` - 图片代理
- `/api/video-proxy` - 视频代理
